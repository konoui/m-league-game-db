## 説明
シーズン・ステージ別のプレイヤー別リーチ成功率と最終順位相関を分析するクエリ

## SQL クエリ
```sql
WITH reach_stats AS (
  SELECT 
    ls.start_year,
    ss.stage,
    p.name as player_name,
    t.name as team_name,
    COUNT(CASE WHEN re.is_accepted = true THEN 1 END) as successful_reach_count,
    COUNT(re.event_id) as total_reach_count,
    CASE 
      WHEN COUNT(re.event_id) > 0 
      THEN ROUND(COUNT(CASE WHEN re.is_accepted = true THEN 1 END) * 100.0 / COUNT(re.event_id), 2)
      ELSE 0 
    END as reach_success_rate
  FROM league_season ls
  JOIN season_stage ss ON ls.id = ss.league_season_id
  JOIN game g ON ss.id = g.season_stage_id
  JOIN kyoku k ON g.id = k.game_id
  JOIN event e ON k.id = e.kyoku_id
  JOIN reach_event re ON e.id = re.event_id
  JOIN player p ON re.actor_player_id = p.id
  JOIN player_team pt ON p.id = pt.player_id 
    AND ls.start_year >= pt.joined_season_year 
    AND ls.start_year <= pt.left_season_year
  JOIN team t ON pt.team_id = t.id
  GROUP BY ls.start_year, ss.stage, p.id, p.name, t.name
),
rank_stats AS (
  SELECT 
    ls.start_year,
    ss.stage,
    p.name as player_name,
    AVG(gpr.rank) as avg_rank,
    COUNT(CASE WHEN gpr.rank = 1 THEN 1 END) as rank1_count,
    COUNT(CASE WHEN gpr.rank <= 2 THEN 1 END) as top2_count,
    COUNT(gpr.game_id) as total_games,
    ROUND(COUNT(CASE WHEN gpr.rank = 1 THEN 1 END) * 100.0 / COUNT(gpr.game_id), 2) as top_rate,
    ROUND(COUNT(CASE WHEN gpr.rank <= 2 THEN 1 END) * 100.0 / COUNT(gpr.game_id), 2) as top2_rate
  FROM league_season ls
  JOIN season_stage ss ON ls.id = ss.league_season_id
  JOIN game g ON ss.id = g.season_stage_id
  JOIN game_player_result gpr ON g.id = gpr.game_id
  JOIN player p ON gpr.player_id = p.id
  GROUP BY ls.start_year, ss.stage, p.id, p.name
)
SELECT 
  rs.start_year,
  rs.stage,
  rs.player_name,
  rs.team_name,
  rs.total_reach_count,
  rs.successful_reach_count,
  rs.reach_success_rate,
  rks.total_games,
  ROUND(rks.avg_rank, 2) as avg_rank,
  rks.top_rate,
  rks.top2_rate,
  CASE 
    WHEN rs.reach_success_rate >= 85 THEN 'High'
    WHEN rs.reach_success_rate >= 70 THEN 'Medium' 
    ELSE 'Low'
  END as reach_efficiency_category,
  CASE 
    WHEN rks.avg_rank <= 2.0 THEN 'Strong'
    WHEN rks.avg_rank <= 2.5 THEN 'Average'
    ELSE 'Weak'
  END as performance_category
FROM reach_stats rs
JOIN rank_stats rks ON rs.start_year = rks.start_year 
  AND rs.stage = rks.stage 
  AND rs.player_name = rks.player_name
WHERE rs.total_reach_count >= 10
ORDER BY rs.start_year, rs.stage, rs.reach_success_rate DESC;
```

## 参照テーブル
- league_season
- season_stage
- game
- kyoku
- event
- reach_event
- player
- player_team
- team
- game_player_result
