## 説明
シーズン・ステージ別のチーム連続4着記録上位10件を取得するクエリ

## SQL クエリ
```sql
WITH team_games AS (
    SELECT 
        ls.start_year AS season_year,
        ss.stage,
        t.name AS team_name,
        g.date,
        g.match_number,
        MAX(gpr.rank) AS team_worst_rank,
        CASE WHEN MAX(gpr.rank) = 4 THEN 1 ELSE 0 END AS is_fourth_place,
        ROW_NUMBER() OVER (PARTITION BY t.id, ls.start_year, ss.stage ORDER BY g.date, g.match_number) AS game_sequence
    FROM game_player_result gpr
    JOIN player p ON gpr.player_id = p.id
    JOIN game g ON gpr.game_id = g.id
    JOIN season_stage ss ON g.season_stage_id = ss.id
    JOIN league_season ls ON ss.league_season_id = ls.id
    JOIN player_team pt ON p.id = pt.player_id 
        AND ls.start_year >= pt.joined_season_year 
        AND ls.start_year <= pt.left_season_year
    JOIN team t ON pt.team_id = t.id
    GROUP BY ls.start_year, ss.stage, t.id, t.name, g.id, g.date, g.match_number
),
streak_groups AS (
    SELECT 
        season_year,
        stage,
        team_name,
        date,
        team_worst_rank,
        is_fourth_place,
        game_sequence,
        game_sequence - ROW_NUMBER() OVER (PARTITION BY team_name, season_year, stage, is_fourth_place ORDER BY game_sequence) AS streak_group
    FROM team_games
),
consecutive_streaks AS (
    SELECT 
        season_year,
        stage,
        team_name,
        streak_group,
        COUNT(*) AS streak_length,
        MIN(date) AS streak_start_date,
        MAX(date) AS streak_end_date
    FROM streak_groups
    WHERE is_fourth_place = 1
    GROUP BY season_year, stage, team_name, streak_group
)
SELECT 
    season_year AS シーズン年,
    stage AS ステージ,
    team_name AS チーム名,
    streak_length AS 連続4位回数,
    streak_start_date AS 記録開始日,
    streak_end_date AS 記録終了日
FROM consecutive_streaks
ORDER BY streak_length DESC, season_year DESC, stage, team_name
LIMIT 10;
```

## 参照テーブル
- game_player_result
- player
- game
- season_stage
- league_season
- player_team
- team
