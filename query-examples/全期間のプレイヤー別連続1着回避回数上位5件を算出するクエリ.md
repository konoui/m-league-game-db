## 説明
全期間のプレイヤー別連続1着回避回数上位5件を算出するクエリ

## SQL クエリ
```sql
WITH player_games AS (
    SELECT 
        p.name AS player_name,
        t.name AS team_name,
        ls.start_year AS season_year,
        ss.stage,
        g.date,
        g.match_number,
        gpr.rank,
        CASE WHEN gpr.rank != 1 THEN 1 ELSE 0 END AS is_not_first,
        ROW_NUMBER() OVER (PARTITION BY p.id ORDER BY ls.start_year, ss.stage, g.date, g.match_number) AS game_sequence
    FROM game_player_result gpr
    JOIN player p ON gpr.player_id = p.id
    JOIN game g ON gpr.game_id = g.id
    JOIN season_stage ss ON g.season_stage_id = ss.id
    JOIN league_season ls ON ss.league_season_id = ls.id
    JOIN player_team pt ON p.id = pt.player_id 
        AND ls.start_year >= pt.joined_season_year 
        AND ls.start_year <= pt.left_season_year
    JOIN team t ON pt.team_id = t.id
),
streak_groups AS (
    SELECT 
        player_name,
        team_name,
        season_year,
        stage,
        date,
        match_number,
        rank,
        is_not_first,
        game_sequence,
        game_sequence - ROW_NUMBER() OVER (PARTITION BY player_name, is_not_first ORDER BY game_sequence) AS streak_group
    FROM player_games
),
consecutive_streaks AS (
    SELECT 
        player_name,
        team_name,
        streak_group,
        COUNT(*) AS streak_length,
        MIN(season_year) AS streak_start_season,
        MAX(season_year) AS streak_end_season,
        MIN(date) AS streak_start_date,
        MAX(date) AS streak_end_date
    FROM streak_groups
    WHERE is_not_first = 1
    GROUP BY player_name, team_name, streak_group
)
SELECT 
    player_name AS プレイヤー名,
    team_name AS チーム名,
    streak_length AS 連続1着回避回数,
    streak_start_season AS 記録開始シーズン年,
    streak_end_season AS 記録終了シーズン年,
    streak_start_date AS 記録開始日,
    streak_end_date AS 記録終了日
FROM consecutive_streaks
ORDER BY streak_length DESC, プレイヤー名
LIMIT 5;
```

## 参照テーブル
- game_player_result
- player
- game
- season_stage
- league_season
- player_team
- team
