## 説明
全期間のプレイヤー別連続放銃回数上位5件を算出するクエリ

## SQL クエリ
```sql
WITH game_kyoku_order AS (
    SELECT 
        k.id AS kyoku_id,
        k.game_id,
        k.round,
        k.honba_count,
        ROW_NUMBER() OVER (PARTITION BY k.game_id ORDER BY 
            CASE k.round 
                WHEN '1z1' THEN 1 WHEN '1z2' THEN 2 WHEN '1z3' THEN 3 WHEN '1z4' THEN 4
                WHEN '2z1' THEN 5 WHEN '2z2' THEN 6 WHEN '2z3' THEN 7 WHEN '2z4' THEN 8
            END, k.honba_count) AS kyoku_order
    FROM kyoku k
),
player_dealin AS (
    SELECT 
        ae.target_player_id AS player_id,
        gko.game_id,
        gko.kyoku_order,
        p.name AS player_name,
        t.name AS team_name,
        ls.start_year AS season_year,
        ss.stage,
        g.date
    FROM agari_event ae
    JOIN event e ON ae.event_id = e.id
    JOIN game_kyoku_order gko ON e.kyoku_id = gko.kyoku_id
    JOIN player p ON ae.target_player_id = p.id
    JOIN game g ON gko.game_id = g.id
    JOIN season_stage ss ON g.season_stage_id = ss.id
    JOIN league_season ls ON ss.league_season_id = ls.id
    JOIN player_team pt ON p.id = pt.player_id 
        AND ls.start_year >= pt.joined_season_year 
        AND ls.start_year <= pt.left_season_year
    JOIN team t ON pt.team_id = t.id
    WHERE ae.target_player_id IS NOT NULL
),
streak_groups AS (
    SELECT 
        player_id,
        game_id,
        player_name,
        team_name,
        season_year,
        stage,
        date,
        kyoku_order,
        kyoku_order - ROW_NUMBER() OVER (PARTITION BY player_id, game_id ORDER BY kyoku_order) AS streak_group
    FROM player_dealin
),
consecutive_dealin AS (
    SELECT 
        player_id,
        game_id,
        player_name,
        team_name,
        season_year,
        stage,
        date,
        COUNT(*) AS consecutive_dealin_count,
        MIN(kyoku_order) AS streak_start_kyoku,
        MAX(kyoku_order) AS streak_end_kyoku
    FROM streak_groups
    GROUP BY player_id, game_id, player_name, team_name, season_year, stage, date, streak_group
    HAVING COUNT(*) >= 2
)
SELECT 
    season_year AS シーズン年,
    stage AS ステージ,
    date AS 試合日,
    player_name AS プレイヤー名,
    team_name AS チーム名,
    consecutive_dealin_count AS 連続放銃回数,
    streak_start_kyoku AS 記録開始局順,
    streak_end_kyoku AS 記録終了局順
FROM consecutive_dealin
ORDER BY consecutive_dealin_count DESC, season_year DESC, date DESC
LIMIT 5;
```

## 参照テーブル
- kyoku
- agari_event
- event
- player
- game
- season_stage
- league_season
- player_team
- team
