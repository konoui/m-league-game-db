## 説明
シーズン・ステージ別のプレイヤー別7順目各種シャンテン数を算出するクエリ

## SQL クエリ
```sql
WITH turn7_shanten AS (
    SELECT 
        ls.start_year AS season_year,
        ss.stage,
        p.name AS player_name,
        t.name AS team_name,
        ps.shanten_count,
        ps.seven_pairs_shanten_count,
        ps.standard_type_shanten_count,
        ps.thirteen_orphans_shanten_count
    FROM player_state ps
    JOIN event e ON ps.event_id = e.id
    JOIN kyoku k ON e.kyoku_id = k.id
    JOIN game g ON k.game_id = g.id
    JOIN season_stage ss ON g.season_stage_id = ss.id
    JOIN league_season ls ON ss.league_season_id = ls.id
    JOIN player p ON ps.player_id = p.id
    JOIN player_team pt ON p.id = pt.player_id 
        AND ls.start_year >= pt.joined_season_year 
        AND ls.start_year <= pt.left_season_year
    JOIN team t ON pt.team_id = t.id
    WHERE ps.turn_number = 7
)
SELECT 
    season_year AS シーズン年,
    stage AS ステージ,
    player_name AS プレイヤー名,
    team_name AS チーム名,
    COUNT(*) AS 局数,
    ROUND(AVG(shanten_count), 3) AS 平均シャンテン数,
    ROUND(AVG(seven_pairs_shanten_count), 3) AS 平均七対子シャンテン数,
    ROUND(AVG(standard_type_shanten_count), 3) AS 平均標準形シャンテン数,
    ROUND(AVG(thirteen_orphans_shanten_count), 3) AS 平均国士無双シャンテン数
FROM turn7_shanten
GROUP BY season_year, stage, player_name, team_name
ORDER BY season_year DESC, stage, 平均シャンテン数 DESC, player_name;
```

## 参照テーブル
- player_state
- event
- kyoku
- game
- season_stage
- league_season
- player
- player_team
- team
