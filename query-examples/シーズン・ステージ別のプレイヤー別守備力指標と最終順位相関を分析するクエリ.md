## 説明
シーズン・ステージ別のプレイヤー別守備力指標と最終順位相関を分析するクエリ

## SQL クエリ
```sql
WITH player_defensive_stats AS (
  SELECT 
    p.name as player_name,
    ls.start_year as season,
    ss.stage,
    COUNT(DISTINCT g.id) as total_games,
    COUNT(CASE WHEN ae.target_player_id = p.id THEN 1 END) as houjuu_count,
    COUNT(CASE WHEN ae.actor_player_id = p.id THEN 1 END) as agari_count,
    COUNT(DISTINCT k.id) as total_kyoku,
    ROUND(CAST(COUNT(CASE WHEN ae.target_player_id = p.id THEN 1 END) AS FLOAT) / COUNT(DISTINCT k.id) * 100, 2) as houjuu_rate,
    ROUND(CAST(COUNT(CASE WHEN ae.actor_player_id = p.id THEN 1 END) AS FLOAT) / COUNT(DISTINCT k.id) * 100, 2) as agari_rate,
    AVG(CASE WHEN ae.target_player_id = p.id THEN ae.points END) as avg_houjuu_points
  FROM player p
  JOIN game_player_result gpr ON p.id = gpr.player_id
  JOIN game g ON gpr.game_id = g.id
  JOIN season_stage ss ON g.season_stage_id = ss.id
  JOIN league_season ls ON ss.league_season_id = ls.id
  JOIN kyoku k ON g.id = k.game_id
  LEFT JOIN event e ON k.id = e.kyoku_id
  LEFT JOIN agari_event ae ON e.id = ae.event_id
  GROUP BY p.id, p.name, ls.start_year, ss.stage
),
player_rankings AS (
  SELECT 
    p.name as player_name,
    ls.start_year as season,
    ss.stage,
    AVG(gpr.rank) as avg_rank,
    COUNT(CASE WHEN gpr.rank = 1 THEN 1 END) as first_place_count,
    COUNT(CASE WHEN gpr.rank <= 2 THEN 1 END) as rentai_count,
    COUNT(CASE WHEN gpr.rank = 4 THEN 1 END) as last_place_count,
    COUNT(*) as total_games
  FROM player p
  JOIN game_player_result gpr ON p.id = gpr.player_id
  JOIN game g ON gpr.game_id = g.id
  JOIN season_stage ss ON g.season_stage_id = ss.id
  JOIN league_season ls ON ss.league_season_id = ls.id
  GROUP BY p.id, p.name, ls.start_year, ss.stage
)
SELECT 
  pds.player_name,
  pds.season,
  pds.stage,
  pds.houjuu_rate,
  pds.agari_rate,
  ROUND((1 - pds.houjuu_rate/100) * (pr.rentai_count * 100.0 / pr.total_games), 2) as defensive_efficiency,
  pr.avg_rank,
  pr.first_place_count,
  pr.rentai_count,
  pr.last_place_count,
  pr.total_games,
  ROUND(pr.rentai_count * 100.0 / pr.total_games, 2) as rentai_rate,
  ROUND(pr.last_place_count * 100.0 / pr.total_games, 2) as last_avoidance_rate
FROM player_defensive_stats pds
JOIN player_rankings pr ON pds.player_name = pr.player_name 
  AND pds.season = pr.season 
  AND pds.stage = pr.stage
WHERE pds.total_games >= 10
ORDER BY pds.season, pds.stage, defensive_efficiency DESC;
```

## 参照テーブル
- player
- game_player_result
- game
- season_stage
- league_season
- kyoku
- event
- agari_event
