## 説明
シーズン・ステージ別のプレイヤー連続連対記録上位10件を算出するクエリ

## SQL クエリ
```sql
WITH player_games AS (
    SELECT 
        p.name AS player_name,
        t.name AS team_name,
        ls.start_year AS season_year,
        ss.stage,
        g.date,
        gpr.rank,
        CASE WHEN gpr.rank <= 2 THEN 1 ELSE 0 END AS is_rentai,
        ROW_NUMBER() OVER (PARTITION BY p.id, ls.start_year, ss.stage ORDER BY g.date, g.match_number) AS game_sequence
    FROM game_player_result gpr
    JOIN player p ON gpr.player_id = p.id
    JOIN game g ON gpr.game_id = g.id
    JOIN season_stage ss ON g.season_stage_id = ss.id
    JOIN league_season ls ON ss.league_season_id = ls.id
    JOIN player_team pt ON p.id = pt.player_id 
        AND ls.start_year >= pt.joined_season_year 
        AND ls.start_year <= pt.left_season_year
    JOIN team t ON pt.team_id = t.id
),
streak_groups AS (
    SELECT 
        player_name,
        team_name,
        season_year,
        stage,
        date,
        rank,
        is_rentai,
        game_sequence,
        game_sequence - ROW_NUMBER() OVER (PARTITION BY player_name, season_year, stage, is_rentai ORDER BY game_sequence) AS streak_group
    FROM player_games
),
consecutive_streaks AS (
    SELECT 
        player_name,
        team_name,
        season_year,
        stage,
        streak_group,
        COUNT(*) AS streak_length,
        MIN(date) AS streak_start_date,
        MAX(date) AS streak_end_date
    FROM streak_groups
    WHERE is_rentai = 1
    GROUP BY player_name, team_name, season_year, stage, streak_group
)
SELECT 
    season_year AS シーズン年,
    stage AS ステージ,
    player_name AS プレイヤー名,
    team_name AS チーム名,
    streak_length AS 連続連対記録,
    streak_start_date AS 記録開始日,
    streak_end_date AS 記録終了日
FROM consecutive_streaks
ORDER BY streak_length DESC, season_year DESC, stage, プレイヤー名
LIMIT 10;
```

## 参照テーブル
- game_player_result
- player
- game
- season_stage
- league_season
- player_team
- team
