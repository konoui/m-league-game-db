## 説明
シーズン・ステージ別プレイヤー基本統計指標を算出するクエリ

## SQL クエリ
```sql
WITH player_kyoku AS (
    SELECT 
        ls.start_year,
        ss.stage,
        p.name AS player_name,
        t.name AS team_name,
        k.id AS kyoku_id,
        p.id AS player_id
    FROM kyoku k
    JOIN game g ON k.game_id = g.id
    JOIN season_stage ss ON g.season_stage_id = ss.id
    JOIN league_season ls ON ss.league_season_id = ls.id
    JOIN kyoku_player_result kpr ON k.id = kpr.kyoku_id
    JOIN player p ON kpr.player_id = p.id
    JOIN player_team pt ON p.id = pt.player_id AND ls.start_year >= pt.joined_season_year AND ls.start_year <= pt.left_season_year
    JOIN team t ON pt.team_id = t.id
),
game_results AS (
    SELECT 
        ls.start_year,
        ss.stage,
        p.name AS player_name,
        t.name AS team_name,
        gpr.rank,
        gpr.score
    FROM game_player_result gpr
    JOIN player p ON gpr.player_id = p.id
    JOIN game g ON gpr.game_id = g.id
    JOIN season_stage ss ON g.season_stage_id = ss.id
    JOIN league_season ls ON ss.league_season_id = ls.id
    JOIN player_team pt ON p.id = pt.player_id AND ls.start_year >= pt.joined_season_year AND ls.start_year <= pt.left_season_year
    JOIN team t ON pt.team_id = t.id
),
win_stats AS (
    SELECT 
        pk.start_year,
        pk.stage,
        pk.player_name,
        pk.team_name,
        COUNT(ae.event_id) AS win_count,
        AVG(CASE WHEN ae.event_id IS NOT NULL THEN ae.base_points END) AS avg_win_points
    FROM player_kyoku pk
    LEFT JOIN event e_win ON pk.kyoku_id = e_win.kyoku_id AND e_win.type IN ('ron', 'tsumo')
    LEFT JOIN agari_event ae ON e_win.id = ae.event_id AND ae.actor_player_id = pk.player_id
    GROUP BY pk.start_year, pk.stage, pk.player_name, pk.team_name
),
dealin_stats AS (
    SELECT 
        pk.start_year,
        pk.stage,
        pk.player_name,
        COUNT(ae_dealin.event_id) AS dealin_count,
        AVG(CASE WHEN ae_dealin.event_id IS NOT NULL THEN ae_dealin.base_points END) AS avg_dealin_points
    FROM player_kyoku pk
    LEFT JOIN event e_dealin ON pk.kyoku_id = e_dealin.kyoku_id AND e_dealin.type = 'ron'
    LEFT JOIN agari_event ae_dealin ON e_dealin.id = ae_dealin.event_id AND ae_dealin.target_player_id = pk.player_id
    GROUP BY pk.start_year, pk.stage, pk.player_name
),
reach_stats AS (
    SELECT 
        pk.start_year,
        pk.stage,
        pk.player_name,
        COUNT(re.event_id) AS reach_count
    FROM player_kyoku pk
    LEFT JOIN event e_reach ON pk.kyoku_id = e_reach.kyoku_id AND e_reach.type = 'reach'
    LEFT JOIN reach_event re ON e_reach.id = re.event_id AND re.actor_player_id = pk.player_id
    GROUP BY pk.start_year, pk.stage, pk.player_name
),
furo_stats AS (
    SELECT 
        pk.start_year,
        pk.stage,
        pk.player_name,
        COUNT(DISTINCT CASE WHEN ce.event_id IS NOT NULL OR pe.event_id IS NOT NULL OR dke.event_id IS NOT NULL THEN pk.kyoku_id END) AS furo_count
    FROM player_kyoku pk
    LEFT JOIN event e_chi ON pk.kyoku_id = e_chi.kyoku_id AND e_chi.type = 'chi'
    LEFT JOIN chi_event ce ON e_chi.id = ce.event_id AND ce.actor_player_id = pk.player_id
    LEFT JOIN event e_pon ON pk.kyoku_id = e_pon.kyoku_id AND e_pon.type = 'pon'
    LEFT JOIN pon_event pe ON e_pon.id = pe.event_id AND pe.actor_player_id = pk.player_id
    LEFT JOIN event e_kan ON pk.kyoku_id = e_kan.kyoku_id AND e_kan.type = 'daiminkan'
    LEFT JOIN dai_kan_event dke ON e_kan.id = dke.event_id AND dke.actor_player_id = pk.player_id
    GROUP BY pk.start_year, pk.stage, pk.player_name
),
ryukyoku_stats AS (
    SELECT 
        pk.start_year,
        pk.stage,
        pk.player_name,
        COUNT(rpe.event_id) AS ryukyoku_count,
        COUNT(CASE WHEN rpe.is_tenpai = 1 THEN 1 END) AS tenpai_count,
        SUM(COALESCE(rpe.point, 0)) AS tenpai_point_total
    FROM player_kyoku pk
    LEFT JOIN event e_ryukyoku ON pk.kyoku_id = e_ryukyoku.kyoku_id AND e_ryukyoku.type = 'ryukyoku'
    LEFT JOIN ryukyoku_player_event rpe ON e_ryukyoku.id = rpe.event_id AND rpe.player_id = pk.player_id
    GROUP BY pk.start_year, pk.stage, pk.player_name
),
stats AS (
    SELECT 
        pk.start_year,
        pk.stage,
        pk.player_name,
        pk.team_name,
        COUNT(DISTINCT pk.kyoku_id) AS total_kyoku,
        ws.win_count,
        ds.dealin_count,
        rs.reach_count,
        fs.furo_count,
        rys.ryukyoku_count,
        rys.tenpai_count,
        rys.tenpai_point_total,
        ws.avg_win_points,
        ds.avg_dealin_points
    FROM player_kyoku pk
    LEFT JOIN win_stats ws ON pk.start_year = ws.start_year AND pk.stage = ws.stage AND pk.player_name = ws.player_name
    LEFT JOIN dealin_stats ds ON pk.start_year = ds.start_year AND pk.stage = ds.stage AND pk.player_name = ds.player_name
    LEFT JOIN reach_stats rs ON pk.start_year = rs.start_year AND pk.stage = rs.stage AND pk.player_name = rs.player_name
    LEFT JOIN furo_stats fs ON pk.start_year = fs.start_year AND pk.stage = fs.stage AND pk.player_name = fs.player_name
    LEFT JOIN ryukyoku_stats rys ON pk.start_year = rys.start_year AND pk.stage = rys.stage AND pk.player_name = rys.player_name
    GROUP BY pk.start_year, pk.stage, pk.player_name, pk.team_name
),
rank_stats AS (
    SELECT 
        start_year,
        stage,
        player_name,
        team_name,
        COUNT(*) AS total_games,
        COUNT(CASE WHEN rank = 1 THEN 1 END) AS rank1_count,
        COUNT(CASE WHEN rank = 2 THEN 1 END) AS rank2_count,
        COUNT(CASE WHEN rank = 3 THEN 1 END) AS rank3_count,
        COUNT(CASE WHEN rank = 4 THEN 1 END) AS rank4_count,
        MAX(score) AS best_score
    FROM game_results
    GROUP BY start_year, stage, player_name
)
SELECT 
    s.start_year AS シーズン年度,
    s.stage AS ステージ,
    s.player_name AS プレイヤー名,
    s.team_name AS チーム名,
    s.total_kyoku AS 総局数,
    rs.total_games AS 総ゲーム数,
    ROUND(s.win_count * 100.0 / s.total_kyoku, 2) AS 和了率_パーセント,
    ROUND(s.dealin_count * 100.0 / s.total_kyoku, 2) AS 放銃率_パーセント,
    ROUND(s.furo_count * 100.0 / s.total_kyoku, 2) AS 副露率_パーセント,
    ROUND(s.reach_count * 100.0 / s.total_kyoku, 2) AS 立直率_パーセント,
    ROUND(s.ryukyoku_count * 100.0 / s.total_kyoku, 2) AS 流局率_パーセント,
    ROUND(CASE WHEN s.ryukyoku_count > 0 THEN s.tenpai_count * 100.0 / s.ryukyoku_count ELSE 0 END, 2) AS 流局時聴牌率_パーセント,
    ROUND(CASE WHEN s.ryukyoku_count > 0 THEN s.tenpai_point_total * 1.0 / s.ryukyoku_count ELSE 0 END, 1) AS 流局時テンパイ料収支,
    rs.rank1_count AS 一位回数,
    rs.rank2_count AS 二位回数,
    rs.rank3_count AS 三位回数,
    rs.rank4_count AS 四位回数,
    ROUND(rs.rank1_count * 100.0 / rs.total_games, 2) AS トップ率_パーセント,
    ROUND((rs.rank1_count + rs.rank2_count) * 100.0 / rs.total_games, 2) AS 連対率_パーセント,
    ROUND((rs.rank1_count + rs.rank2_count + rs.rank3_count) * 100.0 / rs.total_games, 2) AS ラス回避率_パーセント,
    rs.best_score AS ベストスコア,
    ROUND(s.avg_win_points, 0) AS 平均打点,
    ROUND(s.avg_dealin_points, 0) AS 放銃平均打点
FROM stats s
LEFT JOIN rank_stats rs ON s.start_year = rs.start_year AND s.stage = rs.stage AND s.player_name = rs.player_name
ORDER BY s.start_year, s.stage, 和了率_パーセント DESC;
```

## 参照テーブル
- kyoku
- game
- season_stage
- league_season
- kyoku_player_result
- game_player_result
- player
- player_team
- team
- event
- agari_event
- reach_event
- chi_event
- pon_event
- dai_kan_event
- ryukyoku_player_event
